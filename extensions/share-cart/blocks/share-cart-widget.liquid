{% comment %}
  Share Cart Widget App Block
{% endcomment %}

{% assign widget_settings = shop.metafields.share_cart.widget_settings.value %}
{% assign display_str = widget_settings.display | join: ',' %}

{% assign store_name = shop.name | default: shop.domain | default: 'this store' %}

{% if widget_settings.coupon.discountType == 'fixed' and widget_settings.coupon.fixedAmount and widget_settings.coupon.fixedAmount != blank %}
  {% assign discount = widget_settings.coupon.fixedAmount | prepend: '$' %}
{% else %}
  {% assign discount = widget_settings.coupon.percentageValue | append: '%' %}
{% endif %}




  {% assign share_cart_link = 'https://' | append: shop.domain | append: '/tools/share-cart?cart=' %}
{% assign message = widget_settings.text %}
{% assign share_message = widget_settings.coupon.customMessage 
  | replace: '[Insert Store Name]', store_name 
  | replace: '[Insert Discount]', discount 
  | replace: '[Insert Link]', share_cart_link %}

{% if display_str contains 'cart_page' %}
  <!-- Cart Page Widget -->
  <div style="
    background: {{ widget_settings.colors.background }};
    border-radius: 12px;
    padding: 24px;
    min-height: 180px;
    width: 100%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    display: flex;
    align-items: center;
    gap: 24px;
    justify-content: center;
  ">
    <div>
      <p style="
        color: {{ widget_settings.colors.text }};
        font-size: 18px;
        margin-bottom: 12px;
        text-align: center;
      ">{{ message }}</p>
      <div style="
        display: flex;
        gap: 16px;
        flex-direction: row;
        align-items: center;
        justify-content: center;
      ">
      {% render 'share-cart-buttons',
  button_style: widget_settings.button_style,
  colors: widget_settings.colors,
  direction: 'row',
  coupon: widget_settings.coupon,
  share_message: share_message
%}
    </div>
      <p style="
        color: {{ widget_settings.colors.text }};
        font-size: 18px;
        margin-bottom: 12px;
        text-align: center;
        margin-top: 8px;
      ">No thanks! I prefer not to get a discount</p>
    </div>
  </div>
{% endif %}

{% if display_str contains 'product_page' %}
  <!-- Product Page Widget -->
  <div style="
    background: {{ widget_settings.colors.background }};
    border-radius: 12px;
    padding: 24px;
    min-height: 180px;
    width: 100%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    margin: 24px 0;
  ">
    <p style="
      color: {{ widget_settings.colors.text }};
      font-size: 18px;
      margin-bottom: 12px;
      text-align: center;
    ">{{ message }}</p>
    {% render 'share-cart-buttons',
  button_style: widget_settings.button_style,
  colors: widget_settings.colors,
  direction: 'row',
  coupon: widget_settings.coupon,
  share_message: share_message
%}
    <p style="
      color: {{ widget_settings.colors.text }};
      font-size: 18px;
      margin-bottom: 12px;
      text-align: center;
      margin-top: 8px;
    ">No thanks! I prefer not to get a discount</p>
  </div>
{% endif %}

{% if display_str contains 'add_to_cart' %}
  <!-- Add to Cart Popup -->
  <div id="share-cart-popup" style="
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.32);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  ">
    <div style="
      background: {{ widget_settings.colors.background }};
      border-radius: 16px;
      padding: 32px;
      min-width: 320px;
      max-width: 90vw;
      margin: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      position: relative;
    ">
      <p style="
        color: {{ widget_settings.colors.text }};
        font-size: 18px;
        margin-bottom: 16px;
        text-align: center;
      ">{{ message }}</p>
      {% render 'share-cart-buttons',
  button_style: widget_settings.button_style,
  colors: widget_settings.colors,
  direction: 'column',
  coupon: widget_settings.coupon,
  share_message: share_message
%}
      <p style="
        color: {{ widget_settings.colors.text }};
        font-size: 18px;
        margin-bottom: 12px;
        text-align: center;
        margin-top: 8px;
        cursor: pointer;
      " onclick="document.getElementById('share-cart-popup').style.display='none'">No thanks! I prefer not to get a discount</p>
    </div>
  </div>
{% endif %}

{% if display_str contains 'checkout' %}
  <!-- Checkout Popup -->
  <div id="share-cart-popup" style="
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.32);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  ">
    <div style="
      background: {{ widget_settings.colors.background }};
      border-radius: 16px;
      padding: 32px;
      min-width: 320px;
      max-width: 90vw;
      margin: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      position: relative;
    ">
      <p style="
        color: {{ widget_settings.colors.text }};
        font-size: 18px;
        margin-bottom: 16px;
        text-align: center;
      ">{{ message }}</p>
      {% render 'share-cart-buttons',
  button_style: widget_settings.button_style,
  colors: widget_settings.colors,
  direction: 'column',
  coupon: widget_settings.coupon,
  share_message: share_message
%}
      <p style="
        color: {{ widget_settings.colors.text }};
        font-size: 18px;
        margin-bottom: 12px;
        text-align: center;
        margin-top: 8px;
        cursor: pointer;
      " onclick="document.getElementById('share-cart-popup').style.display='none'">No thanks! I prefer not to get a discount</p>
    </div>
  </div>
{% endif %}

<script>
  // Show popup on add to cart
  document.addEventListener('DOMContentLoaded', function() {
    var popup = document.getElementById('share-cart-popup');
    if (!popup) return;

    // Example: Show on add to cart button click
    var addToCartBtn = document.querySelector('form[action*="/cart/add"] [type="submit"], button[name="add"]');
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', function(e) {
        setTimeout(function() {
          popup.style.display = 'flex';
        }, 500); // delay to allow cart logic
      });
    }

    // Example: Show on checkout button click
    var checkoutBtn = document.querySelector('form[action*="/cart"] [type="submit"], button[name="checkout"]');
    if (checkoutBtn) {
      checkoutBtn.addEventListener('click', function(e) {
        setTimeout(function() {
          popup.style.display = 'flex';
        }, 500);
      });
    }

  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // --- Inject cart data and discount code into share links and messages ---
    function updateShareLinks() {
      fetch('/cart.js')
        .then(res => res.json())
        .then(cart => {
          var cartData = {
            items: cart.items.map(function(item) {
              return { id: item.id, quantity: item.quantity };
            })
          };
          var encoded = btoa(JSON.stringify(cartData));
          var discount = "{{ widget_settings.coupon.code | url_encode }}";
          var shopDomain = "{{ shop.domain }}";
          var shareCartLink = "https://" + shopDomain + "/tools/share-cart?cart=" + encoded + (discount ? "&discount=" + discount : "");

          // Prepare the message with the real link
          var rawMessage = `{{ widget_settings.coupon.customMessage | replace: "'", "\\'" | strip_newlines }}`;
          var storeName = "{{ shop.name | escape }}";
          var discountText = `{% if widget_settings.coupon.discountType == 'fixed' and widget_settings.coupon.fixedAmount and widget_settings.coupon.fixedAmount != blank %}${{ widget_settings.coupon.fixedAmount }}{% else %}{{ widget_settings.coupon.percentageValue }}%{% endif %}`;
          var message = rawMessage
            .replace('[Insert Store Name]', storeName)
            .replace('[Insert Discount]', discountText)
            .replace('[Insert Link]', shareCartLink);

          // WhatsApp
          var whatsappBtn = document.querySelector('a[data-share="whatsapp"]');
          if (whatsappBtn) {
            whatsappBtn.href = "https://wa.me/?text=" + encodeURIComponent(message);
          }
          // Messenger
          var messengerBtn = document.querySelector('a[data-share="messenger"]');
          if (messengerBtn) {
            messengerBtn.href = "https://m.me/?link=" + encodeURIComponent(shareCartLink);
          }
          // Email
          var emailBtn = document.querySelector('a[data-share="email"]');
          if (emailBtn) {
            emailBtn.href = "mailto:?subject=" + encodeURIComponent("Check out my cart!") + "&body=" + encodeURIComponent(message);
          }
        });
    }

    // Update links on page load and when popup opens
    updateShareLinks();
    var popup = document.getElementById('share-cart-popup');
    if (popup) {
      popup.addEventListener('show', updateShareLinks);
    }
    // Optionally, update on button hover/click for extra safety
    document.querySelectorAll('a[data-share]').forEach(function(link) {
      link.addEventListener('click', updateShareLinks);
    });
  });
</script>

{% schema %}
{
  "name": "Share Cart Widget",
  "target": "section",
  "settings": []
}
{% endschema %}